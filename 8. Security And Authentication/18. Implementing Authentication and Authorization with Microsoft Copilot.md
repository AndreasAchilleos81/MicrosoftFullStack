# Using AI Tools for .NET Authentication and Authorization

## Introduction

Working with authorization and authentication code can be time-consuming and difficult, especially when learning a new language. When working with .NET, we have tools that make things easier, but there are still many APIs and concepts to understand. AI tools like Copilot can be incredibly useful to help along this journey.

In this guide, we'll explore how to prompt Microsoft Copilot for assistance with implementing authentication and authorization mechanisms in a .NET minimal API.

## Getting Started with Copilot

### Accessing Copilot

There are several ways to access Microsoft Copilot:

1. **Desktop Application** - Available in your system tray
2. **Web Browser** - Navigate to `copilot.microsoft.com`
3. **Edge Extension** - Built-in browser extension in Microsoft Edge

### Best Practice: Start Fresh

Always start with a new chat when beginning a project. Copilot maintains context from previous conversations, which can confuse responses if you switch topics.

**Important**: Click "Start a new chat" before beginning your coding session.

## Initial Prompt Example

Here's an effective initial prompt:

```
Please build me a .NET minimal API with two endpoints. 
One will be the unprotected root route, and the other will be a protected route.
```

### What Copilot Generates

Copilot will typically generate JWT authentication setup. Here's an example of what it might produce:

```csharp
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Authorization;

var builder = WebApplication.CreateBuilder(args);

// Add authentication
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer();

var app = builder.Build();

// Unprotected route
app.MapGet("/", () => "Hello World!");

// Protected route
app.MapGet("/protected", [Authorize] () => "This is protected!")
    .RequireAuthorization();

app.Run();
```

**Note**: Copilot may add `app.UseAuthentication()` and `app.UseAuthorization()` middleware calls, but these are automatically added when you register authentication or authorization services.

## Providing Better Context

For more accurate results, feed Copilot relevant documentation. Here's an improved prompt:

```
Please use this documentation to automatically implement identity and map the API endpoints.
[Paste relevant Microsoft documentation here]
```

### Enhanced Implementation with Identity

After providing documentation context, Copilot will generate code using ASP.NET Core Identity:

```csharp
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Add DbContext with Identity
builder.Services.AddDbContext<IdentityDbContext>(options =>
    options.UseInMemoryDatabase("AppDb"));

// Add Identity
builder.Services.AddIdentity<IdentityUser, IdentityRole>()
    .AddEntityFrameworkStores<IdentityDbContext>();

// Map Identity API endpoints
builder.Services.AddIdentityApiEndpoints<IdentityUser>();

var app = builder.Build();

// Map Identity endpoints (register, login, etc.)
app.MapIdentityApi<IdentityUser>();

// Unprotected route
app.MapGet("/", () => "Hello World!");

// Protected route
app.MapGet("/protected", () => "This is protected!")
    .RequireAuthorization();

app.Run();
```

## Installing Required Dependencies

Ask Copilot for installation commands:

```
Please give me the command line code that I would need to run to install 
Entity Framework Core and in-memory database.
```

### Required NuGet Packages

```bash
# Entity Framework Core
dotnet add package Microsoft.EntityFrameworkCore

# In-Memory Database
dotnet add package Microsoft.EntityFrameworkCore.InMemory

# Identity with Entity Framework Core bridge
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore

# Identity
dotnet add package Microsoft.AspNetCore.Identity
```

## Cleaned Up Implementation

After reviewing and cleaning Copilot's suggestions:

```csharp
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Configure DbContext
builder.Services.AddDbContext<IdentityDbContext>(options =>
    options.UseInMemoryDatabase("AppDb"));

// Configure Identity
builder.Services.AddIdentityApiEndpoints<IdentityUser>()
    .AddEntityFrameworkStores<IdentityDbContext>();

var app = builder.Build();

// Map Identity API endpoints
app.MapIdentityApi<IdentityUser>();

// Unprotected route
app.MapGet("/", () => "Hello World!");

// Protected route
app.MapGet("/protected", () => "This is protected!")
    .RequireAuthorization();

app.Run();
```

## Testing with HTTP Requests

Generate test requests by prompting Copilot:

```
Please generate a requests.http file to create a new user, log them in, 
and then make requests to my two routes.
```

### Sample requests.http File

```http
### Register a new user
POST https://localhost:5014/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "Password123!"
}

### Login with cookies
POST https://localhost:5014/login?useCookies=true
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "Password123!"
}

### Access unprotected route
GET https://localhost:5014/

### Access protected route (requires authentication)
GET https://localhost:5014/protected
```

## Identity API Endpoints

ASP.NET Core Identity provides these built-in endpoints:

- `/register` - Register a new user
- `/login` - Login and receive authentication cookie/token
- `/refresh` - Refresh authentication token
- `/confirmEmail` - Confirm user email
- `/resendConfirmationEmail` - Resend confirmation email
- `/forgotPassword` - Request password reset
- `/resetPassword` - Reset password
- `/manage/2fa` - Two-factor authentication management
- `/manage/info` - User information management

## Key Takeaways

### Understanding AI Tool Limitations

1. **Hallucination** - AI tools may confidently suggest incorrect or outdated code
2. **Knowledge Cutoff** - Training data is typically 6-12 months old
3. **API Updates** - Newest APIs may not be well-represented in training data
4. **Mixed Patterns** - May combine old and new approaches

### Best Practices

- **Provide Context** - Feed relevant, up-to-date documentation
- **Verify Output** - Review and test all generated code
- **Iterate** - Refine prompts based on results
- **Domain Knowledge** - Understanding fundamentals helps you steer AI tools effectively
- **Think of AI as a Partner** - Like an intern who gets you close, requiring professional guidance

### Effective Workflow

1. Start with a clear prompt
2. Provide relevant documentation for context
3. Review and clean generated code
4. Test thoroughly
5. Iterate and refine as needed

## Conclusion

AI tools like Copilot are excellent for getting up and running quickly with authentication and authorization in .NET. However, they work best as assistants rather than autonomous developers. Your domain knowledge and ability to diagnose issues, combined with AI-generated starting points, creates a powerful workflow for rapid development.

Remember: Don't try to get AI to do everything for you. Use it as a tool and partner to accelerate your development process while maintaining control over the final implementation.