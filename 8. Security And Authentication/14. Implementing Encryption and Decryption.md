# Encryption and Decryption in C# - Implementation Guide

## Overview

Encryption and decryption are critical factors for keeping data secure when it is at rest. While this can often be done directly in your database, you can also implement it through code. This guide explains how to implement basic encryption and decryption techniques in a C# application using AES encryption.

## Application Structure

The application consists of several components:

- API endpoints for encryption and decryption
- Request record types
- An encryption service interface
- The encryption service implementation

## Request Models

```csharp
public record EncryptionRequest(string Value);
public record DecryptionRequest(string Value);
```

## Service Interface

```csharp
public interface IEncryptionService
{
    string Encrypt(string plainText);
    string Decrypt(string cipherText);
}
```

## Encryption Service Implementation

### Configuration Setup

The encryption method requires two key components:
- **Key**: The encryption key
- **IV (Initialization Vector)**: A secondary key for added security

These values are stored in configuration and retrieved in the service constructor:

```csharp
public class EncryptionService : IEncryptionService
{
    private readonly byte[] _key;
    private readonly byte[] _iv;

    public EncryptionService(IConfiguration configuration)
    {
        _key = Convert.FromBase64String(configuration["Encryption:Key"]);
        _iv = Convert.FromBase64String(configuration["Encryption:IV"]);
    }
}
```

### Encrypt Method

The encryption process involves several steps:

1. Create an AES generator
2. Set the key and IV
3. Create an encryptor
4. Create a memory stream
5. Create a crypto stream with write mode
6. Write the plain text using a stream writer
7. Convert the result to a Base64 string

```csharp
public string Encrypt(string plainText)
{
    using var aes = Aes.Create();
    aes.Key = _key;
    aes.IV = _iv;

    using var encryptor = aes.CreateEncryptor(_key, _iv);
    using var ms = new MemoryStream();
    using var cs = new CryptoStream(ms, encryptor, CryptoStreamMode.Write);
    using var writer = new StreamWriter(cs);
    
    writer.Write(plainText);
    writer.Flush();

    return Convert.ToBase64String(ms.ToArray());
}
```

### Decrypt Method

The decryption process mirrors the encryption process but in reverse:

1. Convert the Base64 string back to a byte buffer
2. Create an AES generator
3. Set the key and IV
4. Create a decryptor (not an encryptor!)
5. Create a memory stream with the buffer
6. Create a crypto stream with read mode
7. Read the plain text using a stream reader

```csharp
public string Decrypt(string cipherText)
{
    var buffer = Convert.FromBase64String(cipherText);

    using var aes = Aes.Create();
    aes.Key = _key;
    aes.IV = _iv;

    using var decryptor = aes.CreateDecryptor(_key, _iv);
    using var ms = new MemoryStream(buffer);
    using var cs = new CryptoStream(ms, decryptor, CryptoStreamMode.Read);
    using var reader = new StreamReader(cs);

    return reader.ReadToEnd();
}
```

## API Endpoints

```csharp
[ApiController]
[Route("[controller]")]
public class EncryptionController : ControllerBase
{
    private readonly IEncryptionService _encryptionService;

    public EncryptionController(IEncryptionService encryptionService)
    {
        _encryptionService = encryptionService;
    }

    [HttpPost("encrypt")]
    public IActionResult Encrypt([FromBody] EncryptionRequest request)
    {
        var encrypted = _encryptionService.Encrypt(request.Value);
        return Ok(new { encrypted });
    }

    [HttpPost("decrypt")]
    public IActionResult Decrypt([FromBody] DecryptionRequest request)
    {
        var decrypted = _encryptionService.Decrypt(request.Value);
        return Ok(new { decrypted });
    }
}
```

## Required Using Statements

```csharp
using System.Security.Cryptography;
using System.IO;
using System.Text;
```

## Key Differences Between Encrypt and Decrypt

| Aspect           | Encrypt                    | Decrypt                                    |
| ---------------- | -------------------------- | ------------------------------------------ |
| Input            | Plain text string          | Base64 cipher text string                  |
| AES Method       | `CreateEncryptor()`        | `CreateDecryptor()`                        |
| MemoryStream     | Empty `new MemoryStream()` | Contains buffer `new MemoryStream(buffer)` |
| CryptoStreamMode | `CryptoStreamMode.Write`   | `CryptoStreamMode.Read`                    |
| Stream Type      | `StreamWriter`             | `StreamReader`                             |
| Operation        | `writer.Write()`           | `reader.ReadToEnd()`                       |
| Output           | Base64 string              | Plain text string                          |

## Testing the Implementation

1. Call the encrypt endpoint with plain text:
   ```json
   POST /encryption/encrypt
   {
     "value": "Hello World"
   }
   ```

2. Receive encrypted value:
   ```json
   {
     "encrypted": "8J+6vQ3mKZx..."
   }
   ```

3. Use the encrypted value to test decryption:
   ```json
   POST /encryption/decrypt
   {
     "value": "8J+6vQ3mKZx..."
   }
   ```

4. Verify the decrypted value matches the original plain text.

## Future Enhancements

This encryption service can be extended to:
- Encrypt and decrypt data directly in database operations
- Implement field-level encryption for sensitive data
- Add key rotation mechanisms
- Integrate with key management services

## Security Notes

- Store encryption keys securely (use Azure Key Vault, AWS KMS, etc.)
- Never hardcode keys in source code
- Use appropriate key lengths (AES-256 recommended)
- Rotate keys periodically
- Use unique IVs for each encryption operation in production scenarios