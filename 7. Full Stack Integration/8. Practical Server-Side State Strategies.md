# Blazor Server-Side Caching and Session Storage Tutorial

## Overview

When working with Blazor applications, you have different options for storing user data:

- **Client-side storage**: Data stored on the user's device
- **Server-side storage**: Data stored on the server, allowing synchronization across multiple devices (mobile, desktop, web)

This tutorial demonstrates how to implement both **server-side caching** and **session storage** in Blazor applications.

## Server-Side Caching with Cache Service

Server-side caching allows you to store data in memory on the server, reducing API calls and improving performance. While this example uses in-memory storage, in production you would typically use a database tied to user IDs.

### Cache Service Implementation

```csharp
using Microsoft.Extensions.Caching.Memory;

public class CacheService
{
    private readonly IMemoryCache _cache;

    public CacheService(IMemoryCache cache)
    {
        _cache = cache;
    }

    public T GetOrCreate<T>(string key, Func<T> createItem, TimeSpan cacheDuration)
    {
        if (!_cache.TryGetValue(key, out T cachedItem))
        {
            cachedItem = createItem();
            
            var cacheEntryOptions = new MemoryCacheEntryOptions()
                .SetSlidingExpiration(cacheDuration);
                
            _cache.Set(key, cachedItem, cacheEntryOptions);
        }
        
        return cachedItem;
    }
}
```

### Registering the Cache Service

In your `Program.cs` or `Startup.cs`:

```csharp
// Add memory cache and cache service
builder.Services.AddMemoryCache();
builder.Services.AddSingleton<CacheService>();
```

### FetchData.razor - Using Server-Side Cache

```razor
@page "/fetchdata"
@inject CacheService CacheService

<PageTitle>Weather forecast</PageTitle>

<h1>Weather forecast</h1>

<p>@weatherData</p>

@code {
    private string weatherData = "";

    protected override async Task OnInitializedAsync()
    {
        // Cache data for 5 seconds (in production, you might use 10-15 minutes)
        weatherData = CacheService.GetOrCreate(
            "weather-data", 
            () => {
                // Replace with real API call logic
                var random = new Random();
                var temperature = random.Next(1, 11);
                return $"Current temperature: {temperature}Â°C";
            },
            TimeSpan.FromSeconds(5)
        );
    }
}
```

**How it works:**
- Data is cached for the specified duration (5 seconds in this example)
- Subsequent requests within the cache period return cached data
- After cache expires, new data is generated/fetched
- Reduces server load and API calls

## Session Storage Implementation

Session storage retains data as long as the browser window remains open. Data is cleared when the browser window/tab is closed.

### Counter.razor - Using Session Storage

```razor
@page "/counter"
@inject ISessionStorageService SessionStorage

<PageTitle>Counter</PageTitle>

<h1>Counter</h1>

<p role="status">Current count: @currentCount</p>

<button class="btn btn-primary" @onclick="IncrementCount">Click me</button>

@code {
    private int currentCount = 0;

    protected override async Task OnInitializedAsync()
    {
        // Try to load existing count from session storage
        var storedCount = await SessionStorage.GetItemAsync<int?>("counter-ink");
        if (storedCount.HasValue)
        {
            currentCount = storedCount.Value;
        }
    }

    private async Task IncrementCount()
    {
        currentCount++;
        
        // Save updated count to session storage
        await SessionStorage.SetItemAsync("counter-ink", currentCount);
    }
}
```

### Adding Session Storage Service

Install the Blazored.SessionStorage NuGet package:

```bash
dotnet add package Blazored.SessionStorage
```

Register the service in `Program.cs`:

```csharp
using Blazored.SessionStorage;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container
builder.Services.AddRazorPages();
builder.Services.AddServerSideBlazor();
builder.Services.AddBlazoredSessionStorage();

var app = builder.Build();
```

Add the using statement to `_Imports.razor`:

```razor
@using Blazored.SessionStorage
```

## Key Differences

### Server-Side Caching
- **Persistence**: Data persists across browser sessions
- **Scope**: Shared across all users (unless keyed by user ID)
- **Use Case**: API response caching, expensive computations
- **Duration**: Configurable time-based expiration

### Session Storage
- **Persistence**: Data cleared when browser window closes
- **Scope**: Per-user, per-browser session
- **Use Case**: Temporary user state, form data, UI preferences
- **Duration**: Until browser session ends

## Best Practices

1. **Cache Duration**: Set appropriate cache durations based on data freshness requirements
2. **Memory Management**: Monitor memory usage with server-side caching
3. **User-Specific Caching**: Include user ID in cache keys for user-specific data
4. **Error Handling**: Implement proper error handling for storage operations
5. **Data Serialization**: Ensure complex objects can be properly serialized/deserialized

## Production Considerations

- Replace in-memory caching with distributed cache (Redis, SQL Server) for scalability
- Implement proper user authentication and authorization
- Use database storage for persistent user data
- Consider data privacy and security implications
- Monitor cache hit rates and performance metrics