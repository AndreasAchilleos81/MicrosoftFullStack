# Securing Applications with Azure Identity Management Tools - Practical Guide

## Introduction

Once you've deployed an app to the cloud, it's essential to implement proper security measures to keep your application and its data safe. This guide demonstrates how to secure applications using Azure Identity Management tools through both the command line interface and the Azure portal.

---

## Prerequisites

- An application deployed to Azure
- Azure CLI installed and configured
- Access to Azure portal
- Appropriate permissions in your Azure subscription

---

## 1. Register Application with Azure Active Directory (Entra ID)

### Overview

The first step in securing your application is to register it with Azure Active Directory (now called **Entra ID**). This creates an identity for your application within Azure's identity management system.

### Command

```bash
az ad app create \
  --display-name "secure-web-app" \
  --identifier-uris "https://your-app-uri.azurewebsites.net"
```

### Parameters Explained

- `az ad app create` - Creates a new Azure AD application registration
- `--display-name` - The name of your application in Azure AD
- `--identifier-uris` - The URI of your published Azure website

### What It Does

- Sets up the app in Azure Active Directory/Entra ID
- Creates an identity that can be used for authentication
- If the directory already exists, it updates it with the provided parameters
- Returns a JSON package with application details

### Example Output

```json
{
  "appId": "12345678-1234-1234-1234-123456789012",
  "displayName": "secure-web-app",
  "identifierUris": [
    "https://your-app-uri.azurewebsites.net"
  ],
  "objectId": "abcdefgh-abcd-abcd-abcd-abcdefghijkl",
  ...
}
```

### Use Case

This registration is the foundation for applying permissions and security policies to your application later.

---

## 2. Enable Multi-Factor Authentication (MFA)

### Overview

Multi-factor authentication adds an extra layer of security beyond passwords, requiring users to verify their identity through multiple methods (e.g., password + SMS code).

### Configuration Method

MFA is configured through the **Azure Portal** rather than the command line.

### Step-by-Step Process

#### Step 1: Navigate to Microsoft Entra ID

1. Open the Azure portal
2. Search for "Microsoft Entra ID" in the top search bar
3. Select your default directory

#### Step 2: Access Security Settings

1. In the left navigation, click **Security**
2. Under the **Manage** section, select **Multi-factor authentication**

#### Step 3: Configure MFA Settings

1. Review available MFA options
2. Configure verification methods:
   - SMS text messages
   - Phone calls
   - Mobile app notifications
   - Authenticator app codes

### Portal Navigation Flow

```
Azure Portal
    ↓
Search "Microsoft Entra ID"
    ↓
Select Default Directory
    ↓
Security → Manage → Multi-factor Authentication
    ↓
Configure MFA Options
```

### Important Notes

- **MFA is not a free service** - Requires appropriate licensing
- **Trial available** - You can test MFA features before purchasing
- **Tenant-wide setting** - Applies to all services using Entra ID
- **Best practice** - Highly recommended for applications with sensitive data

### Use Case

For websites or applications handling sensitive data, MFA ensures data safety and is considered essential for modern web applications.

---

## 3. Implement Role-Based Access Control (RBAC)

### Overview

RBAC allows you to assign specific permissions to users based on their roles, controlling what actions they can perform on your application.

### Command

```bash
az role assignment create \
  --assignee "user-object-id" \
  --role "Reader" \
  --scope "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Web/sites/{app-name}"
```

### Parameters Explained

- `az role assignment create` - Creates a new role assignment
- `--assignee` - The object ID of the user receiving the role (long GUID format)
- `--role` - The role to assign (Reader, Contributor, Owner, etc.)
- `--scope` - The resource path where the role applies

### Complete Example

```bash
az role assignment create \
  --assignee "12345678-90ab-cdef-1234-567890abcdef" \
  --role "Reader" \
  --scope "/subscriptions/aaaabbbb-cccc-dddd-eeee-ffffgggghhh/resourceGroups/msft-dev/providers/Microsoft.Web/sites/msft-dev-webapp"
```

### Finding User Object IDs

You can retrieve user object IDs using:

```bash
# List all users in your directory
az ad user list --output table

# Get specific user details
az ad user show --id "user@domain.com" --query objectId -o tsv
```

### Common Azure Roles

| Role | Permissions | Example Use |
|------|-------------|-------------|
| **Reader** | View resources only, no modifications | Auditors, stakeholders |
| **Contributor** | Create and manage resources, cannot assign roles | Developers, operators |
| **Owner** | Full control including role assignments | Administrators |

### Scoping Explained

The `--scope` parameter controls where the role applies:

```bash
# Subscription level (affects all resources)
--scope "/subscriptions/{subscription-id}"

# Resource group level (affects all resources in the group)
--scope "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}"

# Specific resource (affects only this application)
--scope "/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Web/sites/{app-name}"
```

### Example Output

```json
{
  "principalId": "12345678-90ab-cdef-1234-567890abcdef",
  "principalName": "user@domain.com",
  "roleDefinitionName": "Reader",
  "scope": "/subscriptions/.../resourceGroups/msft-dev/providers/Microsoft.Web/sites/msft-dev-webapp",
  "type": "Microsoft.Authorization/roleAssignments"
}
```

### Use Case

When you need to grant a user read-only access to your application, preventing them from making changes or modifying settings, while still allowing visibility for monitoring or auditing purposes.

---

## Complete Security Implementation Workflow

### Step-by-Step Security Setup

```bash
# Step 1: Register your application with Azure AD
az ad app create \
  --display-name "my-secure-app" \
  --identifier-uris "https://my-secure-app.azurewebsites.net"

# Step 2: Get the app ID from the output
# Save the "appId" value for later use

# Step 3: Find user object ID for RBAC assignment
az ad user show --id "developer@company.com" --query objectId -o tsv

# Step 4: Assign Reader role to specific user
az role assignment create \
  --assignee "user-object-id-from-step-3" \
  --role "Reader" \
  --scope "/subscriptions/your-subscription-id/resourceGroups/your-resource-group/providers/Microsoft.Web/sites/my-secure-app"

# Step 5: Verify the role assignment
az role assignment list \
  --assignee "user-object-id-from-step-3" \
  --scope "/subscriptions/your-subscription-id/resourceGroups/your-resource-group/providers/Microsoft.Web/sites/my-secure-app" \
  --output table
```

### Then Configure MFA via Portal

1. Navigate to Azure Portal → Microsoft Entra ID
2. Select Security → Multi-factor Authentication
3. Configure verification methods and policies

---

## Automation with Scripts

### Example: Bulk User Role Assignment Script

```bash
#!/bin/bash

# Configuration
SUBSCRIPTION_ID="your-subscription-id"
RESOURCE_GROUP="msft-dev"
APP_NAME="msft-dev-webapp"
ROLE="Reader"

# Array of user emails
USERS=(
  "user1@company.com"
  "user2@company.com"
  "user3@company.com"
)

# Construct scope
SCOPE="/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Web/sites/$APP_NAME"

# Loop through users and assign roles
for USER_EMAIL in "${USERS[@]}"; do
  echo "Processing $USER_EMAIL..."
  
  # Get user object ID
  USER_ID=$(az ad user show --id "$USER_EMAIL" --query objectId -o tsv)
  
  if [ -n "$USER_ID" ]; then
    # Assign role
    az role assignment create \
      --assignee "$USER_ID" \
      --role "$ROLE" \
      --scope "$SCOPE"
    
    echo "✓ Role assigned to $USER_EMAIL"
  else
    echo "✗ User $USER_EMAIL not found"
  fi
  
  echo "---"
done

echo "Role assignment complete!"
```

### Example: Verify All Role Assignments

```bash
# List all role assignments for a specific application
az role assignment list \
  --scope "/subscriptions/your-subscription-id/resourceGroups/your-resource-group/providers/Microsoft.Web/sites/your-app-name" \
  --output table
```

---

## Key Benefits of Using Azure CLI for Security

### 1. Automation
- Create scripts to manage multiple users
- Consistent security policy application
- Reduce manual errors

### 2. Repeatability
- Deploy same security configurations across environments
- Version control your security scripts
- Easy to replicate setups

### 3. Efficiency
- Quickly assign roles to multiple users
- Batch operations for large teams
- Faster than manual portal configuration

### 4. Integration
- Incorporate into CI/CD pipelines
- Automate security as part of deployment
- Script-based infrastructure as code

---

## Best Practices

### 1. Principle of Least Privilege
Always assign the minimum permissions necessary for users to perform their job functions.

### 2. Use Service Principals for Applications
For app-to-app authentication, use service principals instead of user accounts.

### 3. Regular Access Reviews
Periodically review and update role assignments to ensure they remain appropriate.

### 4. Enable MFA for All Admin Accounts
Always require multi-factor authentication for accounts with elevated privileges.

### 5. Document Role Assignments
Maintain clear documentation of who has what access and why.

### 6. Use Custom Roles When Needed
Create custom roles for specific permission combinations that built-in roles don't provide.

---

## Verification Commands

### Check Application Registration

```bash
# List all registered applications
az ad app list --output table

# Show specific application details
az ad app show --id "app-object-id"
```

### Verify Role Assignments

```bash
# List all role assignments for a user
az role assignment list --assignee "user-object-id" --output table

# List all role assignments for a resource
az role assignment list --scope "resource-scope" --output table
```

### Audit Security Settings

```bash
# List all users in directory
az ad user list --output table

# Show user's group memberships
az ad user get-member-groups --id "user-object-id"
```

---

## Summary

By implementing these three security measures, you create a comprehensive security foundation for your Azure applications:

1. **Azure AD/Entra ID Registration** - Establishes application identity
2. **Multi-Factor Authentication** - Adds verification layer beyond passwords
3. **Role-Based Access Control** - Enforces principle of least privilege

Using the Azure CLI for these operations enables automation, repeatability, and efficient management of security policies across your organization. These tools work together to lock down your website and make it significantly more secure.